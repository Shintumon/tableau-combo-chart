<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Combo Chart Extension</title>

  <!-- Tableau Extensions API (local copy) -->
  <script src="lib/tableau.extensions.min.js"></script>

  <!-- D3.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div id="app">
    <!-- Loading State -->
    <div id="loading" class="loading-container">
      <div class="spinner"></div>
      <p>Loading extension...</p>
    </div>

    <!-- Configuration Required State -->
    <div id="config-required" class="config-required hidden">
      <div class="config-message">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
        <h2>Configuration Required</h2>
        <p>Click the button below or use the context menu to configure the chart.</p>
        <button id="open-config-btn" class="btn btn-primary">Configure Chart</button>
      </div>
    </div>

    <!-- Main Chart Container -->
    <div id="chart-container" class="chart-container hidden">
      <div id="chart-header" class="chart-header">
        <h3 id="chart-title">Combo Chart</h3>
        <div class="chart-controls">
          <button id="toggle-legend" class="btn btn-icon" title="Toggle Legend">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="8" y1="6" x2="21" y2="6"></line>
              <line x1="8" y1="12" x2="21" y2="12"></line>
              <line x1="8" y1="18" x2="21" y2="18"></line>
              <rect x="3" y="4" width="2" height="4" fill="currentColor"></rect>
              <rect x="3" y="10" width="2" height="4" fill="currentColor"></rect>
              <rect x="3" y="16" width="2" height="4" fill="currentColor"></rect>
            </svg>
          </button>
          <button id="open-settings" class="btn btn-icon" title="Settings">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
          </button>
        </div>
      </div>
      <div id="chart-area" class="chart-area">
        <svg id="combo-chart"></svg>
      </div>
      <div id="legend" class="legend"></div>
    </div>

    <!-- Error State -->
    <div id="error-container" class="error-container hidden">
      <div class="error-message">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#e74c3c" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <h2>Error</h2>
        <p id="error-text"></p>
        <button id="retry-btn" class="btn btn-primary">Retry</button>
      </div>
    </div>
  </div>

  <!-- Tooltip -->
  <div id="tooltip" class="tooltip hidden"></div>

  <!-- Context Menu -->
  <div id="context-menu" class="context-menu hidden">
    <div class="context-menu-header" id="context-menu-title">Format</div>
    <div class="context-menu-items" id="context-menu-items">
      <!-- Items populated by JS -->
    </div>
  </div>

  <!-- Debug Console Panel -->
  <div id="debug-panel" class="debug-panel hidden">
    <div class="debug-header" id="debug-header" style="cursor: move;">
      <span>Debug Console (drag to move)</span>
      <div class="debug-actions">
        <button id="debug-clear" class="debug-btn" title="Clear">Clear</button>
        <button id="debug-copy" class="debug-btn" title="Copy">Copy</button>
        <button id="debug-popout" class="debug-btn" title="Open in separate window">‚Üó Pop Out</button>
        <button id="debug-hide" class="debug-btn" title="Hide debug mode (Ctrl+Shift+D to restore)">Hide</button>
        <button id="debug-close" class="debug-btn" title="Close">√ó</button>
      </div>
    </div>
    <div id="debug-content" class="debug-content"></div>
  </div>
  <!-- Debug toggle hidden by default - use Ctrl+Shift+D to show -->
  <button id="debug-toggle" class="debug-toggle hidden" title="Toggle Debug Console (Ctrl+Shift+D)">üêõ</button>

  <script>
    // Debug Console Implementation
    (function() {
      const debugPanel = document.getElementById('debug-panel');
      const debugContent = document.getElementById('debug-content');
      const debugToggle = document.getElementById('debug-toggle');
      const debugClear = document.getElementById('debug-clear');
      const debugCopy = document.getElementById('debug-copy');
      const debugClose = document.getElementById('debug-close');
      const debugHide = document.getElementById('debug-hide');
      const debugPopout = document.getElementById('debug-popout');
      const debugHeader = document.getElementById('debug-header');

      let logs = [];
      let isDragging = false;
      let popoutWindow = null;
      let dragOffsetX = 0;
      let dragOffsetY = 0;
      const MAX_LOGS = 200;

      function addLog(type, ...args) {
        const timestamp = new Date().toLocaleTimeString();
        const message = args.map(arg => {
          if (typeof arg === 'object') {
            try {
              return JSON.stringify(arg, null, 2);
            } catch (e) {
              return String(arg);
            }
          }
          return String(arg);
        }).join(' ');

        const log = { timestamp, type, message };
        logs.push(log);
        if (logs.length > MAX_LOGS) logs.shift();

        const logEl = document.createElement('div');
        logEl.className = `debug-log debug-${type}`;
        logEl.innerHTML = `<span class="debug-time">[${timestamp}]</span> <span class="debug-type">${type.toUpperCase()}</span> ${escapeHtml(message)}`;
        debugContent.appendChild(logEl);
        debugContent.scrollTop = debugContent.scrollHeight;
      }

      function escapeHtml(str) {
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }

      // Override console methods
      const originalConsole = {
        log: console.log.bind(console),
        warn: console.warn.bind(console),
        error: console.error.bind(console),
        info: console.info.bind(console)
      };

      console.log = function(...args) {
        originalConsole.log(...args);
        addLog('log', ...args);
      };
      console.warn = function(...args) {
        originalConsole.warn(...args);
        addLog('warn', ...args);
      };
      console.error = function(...args) {
        originalConsole.error(...args);
        addLog('error', ...args);
      };
      console.info = function(...args) {
        originalConsole.info(...args);
        addLog('info', ...args);
      };

      // Debug log helper
      window.debugLog = function(msg) {
        console.log('[ComboChart]', msg);
      };

      // Global error handler
      window.onerror = function(msg, url, line, col, error) {
        console.error('ERROR:', msg, 'at line', line, col, error?.stack || '');
        return false;
      };

      // Toggle panel
      debugToggle.addEventListener('click', () => {
        debugPanel.classList.toggle('hidden');
        if (!debugPanel.classList.contains('hidden')) {
          // Log environment info when opening
          logEnvironmentInfo();
        }
      });

      debugClose.addEventListener('click', () => {
        debugPanel.classList.add('hidden');
      });

      // Hide button - completely hides debug mode (use Ctrl+Shift+D to restore)
      debugHide.addEventListener('click', () => {
        debugPanel.classList.add('hidden');
        debugToggle.classList.add('hidden');
        console.log('Debug mode hidden. Press Ctrl+Shift+D to restore.');
      });

      // Pop out to separate window
      debugPopout.addEventListener('click', openDebugPopout);

      function openDebugPopout() {
        if (popoutWindow && !popoutWindow.closed) {
          popoutWindow.focus();
          return;
        }

        popoutWindow = window.open('', 'DebugConsoleMain', 'width=600,height=500,resizable=yes,scrollbars=yes');
        if (!popoutWindow) {
          alert('Popup blocked! Please allow popups for this site.');
          return;
        }

        popoutWindow.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>Debug Console - Combo Chart</title>
            <style>
              * { box-sizing: border-box; margin: 0; padding: 0; }
              body {
                font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
                font-size: 12px;
                background: #1e1e1e;
                color: #d4d4d4;
                height: 100vh;
                display: flex;
                flex-direction: column;
              }
              .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 15px;
                background: #2d2d2d;
                border-bottom: 1px solid #3d3d3d;
              }
              .header h1 { font-size: 14px; font-weight: 600; color: #e0e0e0; }
              .actions { display: flex; gap: 8px; }
              .btn {
                background: #3d3d3d;
                border: none;
                color: #e0e0e0;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
              }
              .btn:hover { background: #4d4d4d; }
              .content { flex: 1; overflow-y: auto; padding: 10px; }
              .log {
                padding: 5px 8px;
                margin-bottom: 3px;
                border-radius: 3px;
                white-space: pre-wrap;
                word-break: break-all;
                line-height: 1.5;
              }
              .log:hover { background: rgba(255,255,255,0.05); }
              .time { color: #888; font-size: 11px; }
              .type { font-weight: 600; margin-right: 6px; }
              .log-info .type { color: #569cd6; }
              .log-warn { background: rgba(255,193,7,0.1); }
              .log-warn .type { color: #ffc107; }
              .log-error { background: rgba(244,67,54,0.1); }
              .log-error .type { color: #f44336; }
              .content::-webkit-scrollbar { width: 10px; }
              .content::-webkit-scrollbar-track { background: #1e1e1e; }
              .content::-webkit-scrollbar-thumb { background: #4d4d4d; border-radius: 5px; }
              .status { padding: 8px 15px; background: #252526; border-top: 1px solid #3d3d3d; font-size: 11px; color: #888; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>üêõ Debug Console - Combo Chart</h1>
              <div class="actions">
                <button class="btn" id="clear-btn">Clear</button>
                <button class="btn" id="copy-btn">Copy All</button>
              </div>
            </div>
            <div class="content" id="log-content"></div>
            <div class="status" id="status">Connected to extension</div>
          </body>
          </html>
        `);
        popoutWindow.document.close();

        const popContent = popoutWindow.document.getElementById('log-content');
        const popClear = popoutWindow.document.getElementById('clear-btn');
        const popCopy = popoutWindow.document.getElementById('copy-btn');
        const popStatus = popoutWindow.document.getElementById('status');

        function addLogToPopup(log) {
          const el = popoutWindow.document.createElement('div');
          el.className = 'log log-' + log.type;
          el.innerHTML = '<span class="time">[' + log.timestamp + ']</span> <span class="type">' + log.type.toUpperCase() + '</span> ' + escapeHtml(log.message);
          popContent.appendChild(el);
          popContent.scrollTop = popContent.scrollHeight;
        }

        logs.forEach(addLogToPopup);

        const originalAddLog = addLog;
        addLog = function(type, ...args) {
          const timestamp = new Date().toLocaleTimeString();
          const message = args.map(arg => {
            if (typeof arg === 'object') {
              try { return JSON.stringify(arg, null, 2); }
              catch (e) { return String(arg); }
            }
            return String(arg);
          }).join(' ');

          const log = { timestamp, type, message };
          logs.push(log);
          if (logs.length > MAX_LOGS) logs.shift();

          const logEl = document.createElement('div');
          logEl.className = 'debug-log debug-' + type;
          logEl.innerHTML = '<span class="debug-time">[' + timestamp + ']</span> <span class="debug-type">' + type.toUpperCase() + '</span> ' + escapeHtml(message);
          debugContent.appendChild(logEl);
          debugContent.scrollTop = debugContent.scrollHeight;

          if (popoutWindow && !popoutWindow.closed) {
            addLogToPopup(log);
          }
        };

        popClear.addEventListener('click', () => {
          logs = [];
          popContent.innerHTML = '';
          debugContent.innerHTML = '';
        });

        popCopy.addEventListener('click', () => {
          const text = logs.map(l => '[' + l.timestamp + '] ' + l.type.toUpperCase() + ': ' + l.message).join('\\n');
          popoutWindow.navigator.clipboard.writeText(text).then(() => {
            popCopy.textContent = 'Copied!';
            setTimeout(() => { popCopy.textContent = 'Copy All'; }, 1500);
          }).catch(() => {
            popCopy.textContent = 'Failed';
            setTimeout(() => { popCopy.textContent = 'Copy All'; }, 1500);
          });
        });

        const statusInterval = setInterval(() => {
          if (popoutWindow.closed) {
            clearInterval(statusInterval);
            return;
          }
          popStatus.textContent = 'Logs: ' + logs.length + ' | Connected';
        }, 1000);

        debugPanel.classList.add('hidden');
        console.log('Debug console opened in separate window');
      }

      // Drag functionality
      debugHeader.addEventListener('mousedown', (e) => {
        if (e.target.tagName === 'BUTTON') return; // Don't drag when clicking buttons
        isDragging = true;
        const rect = debugPanel.getBoundingClientRect();
        dragOffsetX = e.clientX - rect.left;
        dragOffsetY = e.clientY - rect.top;
        debugPanel.style.transition = 'none';
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const x = Math.max(0, Math.min(window.innerWidth - 100, e.clientX - dragOffsetX));
        const y = Math.max(0, Math.min(window.innerHeight - 50, e.clientY - dragOffsetY));
        debugPanel.style.left = x + 'px';
        debugPanel.style.top = y + 'px';
        debugPanel.style.right = 'auto';
        debugPanel.style.bottom = 'auto';
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
        debugPanel.style.transition = '';
      });

      debugClear.addEventListener('click', () => {
        logs = [];
        debugContent.innerHTML = '';
        console.log('Debug console cleared');
      });

      debugCopy.addEventListener('click', () => {
        const text = logs.map(l => `[${l.timestamp}] ${l.type.toUpperCase()}: ${l.message}`).join('\n');
        copyToClipboard(text);
      });

      // Clipboard fallback for Tableau webview
      function copyToClipboard(text) {
        // Try modern API first
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(() => {
            showCopyFeedback('Logs copied!');
          }).catch(() => {
            fallbackCopy(text);
          });
        } else {
          fallbackCopy(text);
        }
      }

      function fallbackCopy(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.cssText = 'position:fixed;left:-9999px;top:-9999px';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        try {
          document.execCommand('copy');
          showCopyFeedback('Logs copied!');
        } catch (e) {
          showCopyFeedback('Copy failed - select manually');
          console.error('Copy failed:', e);
        }
        document.body.removeChild(textarea);
      }

      function showCopyFeedback(msg) {
        const origText = debugCopy.textContent;
        debugCopy.textContent = msg;
        setTimeout(() => { debugCopy.textContent = origText; }, 1500);
      }

      // Log environment info
      function logEnvironmentInfo() {
        console.info('=== Environment Info ===');
        try {
          if (typeof tableau !== 'undefined' && tableau.extensions) {
            const env = tableau.extensions.environment;
            console.info('Tableau Version:', env?.tableauVersion || 'N/A');
            console.info('API Version:', env?.apiVersion || 'N/A');
            console.info('Mode:', env?.mode || 'N/A');
            console.info('Context:', env?.context || 'N/A');

            // Workbook Formatting
            if (env?.workbookFormatting) {
              console.info('=== Workbook Formatting ===');
              const sheets = env.workbookFormatting.formattingSheets || [];
              console.info('Formatting Sheets Count:', sheets.length);
              sheets.forEach((sheet, i) => {
                console.info(`Sheet ${i}: classNameKey =`, sheet.classNameKey);
                console.info(`Sheet ${i}: cssProperties =`, sheet.cssProperties);
              });
            } else {
              console.warn('workbookFormatting is NOT available (requires Tableau 2021.4+)');
            }

            // Config Info
            if (typeof Config !== 'undefined') {
              console.info('=== Config ===');
              console.info('Detected Font:', Config.getWorkbookFont() || 'None detected');
              console.info('Current Font Family:', Config.current?.font?.family || 'N/A');
            }
          } else {
            console.warn('Tableau Extensions API not available');
          }
        } catch (e) {
          console.error('Error getting environment info:', e.message);
        }
        console.info('========================');
      }

      // Keyboard shortcut: Ctrl+Shift+D to toggle debug panel
      // This is the only way to access the debug panel (hidden from regular users)
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && e.key === 'D') {
          e.preventDefault();
          // Show the toggle button once debug mode is activated
          debugToggle.classList.remove('hidden');
          debugToggle.click();
        }
      });

      // Also allow ?debug=1 URL parameter for developers
      if (window.location.search.includes('debug=1') || window.location.search.includes('debug=true')) {
        debugToggle.classList.remove('hidden');
      }
    })();
  </script>

  <!-- Scripts -->
  <script src="js/config.js"></script>
  <script src="js/contextMenu.js"></script>
  <script src="js/dataHandler.js"></script>
  <script src="js/comboChart.js"></script>
  <script src="js/main.js"></script>
</body>
</html>
